# 横向联邦学习

## 整体流程

从宏观上来看，横向联邦学习可以分为很多轮训练，每一轮训练都遵循如下的流程：

1. 服务器选择一部分客户端，加入这一轮训练
2. 加入训练的客户端，下载新的模型权重，在本地进行训练
3. 客户端使用安全聚合，上传本地训练好的模型权重（或梯度）到服务器，服务器更新全局的模型权重，供下一轮使用

在这个流程中，我们可以对服务器和客户端的功能进行划分，其中，

客户端的功能为：

* 加入一轮训练
* 下载模型
* 训练模型
* 使用安全聚合上传训练好的模型权重（或梯度）

服务器的功能为：

* 开启一轮训练
* 选择可以加入这轮训练的客户端
* 提供下载模型的接口
* 使用安全聚合，计算全局的模型权重（或梯度）
* 更新全局的模型权重

在设计上，由于每个节点都可以是服务器，提交横向联邦学习任务，也就是说，不存在一个固定的、中心化的服务器，
所以，我们需要一种机制，在创建任务的同时，通知网络中的其他节点，否则其他节点无法知道自己发布了一个新任务，也就无法加入这个任务。
这个功能，我们把它叫做**创建任务**功能。

同样的，当任务结束的时候，我们也需要服务器能够通知到所有的客户端，不然的话，其他客户端
无法分辨出是任务结束了，还是出现了网络延迟，就无法决定是否还要等待新一轮的训练。
我们把这个显示通知任务结束的功能，称为**结束任务**功能。

所以，服务器还有两个额外的功能，也就是**创建任务**和**结束任务**。

综上，在某个节点上提交了横向联邦学习任务后，任务的执行流程如下：

1. 服务器创建任务
2. 客户端收到创建任务的通知后，根据自身的配置，选择是否加入该任务，如果不加入，则退出
3. 服务器开启一轮训练
4. 客户端收到任务开启训练的通知后，加入这轮训练
5. 服务器等待一段时间后，选择可以加入这轮训练的客户端
6. 可以加入这轮训练的客户端，下载任务的配置、执行计划、模型权重等内容；不能加入的，等待下一轮的开始
7. 客户端使用本地数据，进行训练
8. 客户端将训练好的模型权重（或梯度），使用安全聚合，提交给服务器
9. 服务器使用安全聚合，计算全局的模型权重（或梯度）
10. 服务器更新全局的模型权重
11. 如果任务结束，则服务器结束任务，否则跳转到步骤3

## 智能合约

从整体流程上，我们可以发现，客户端是被动的，所有的行为，都要等待服务器的通知，整个任务的执行流程，由服务器来控制。
然而，系统是去中心化的，没有一个固定的服务器。这时，要让客户端能收到服务器的通知，又不破坏整个网络的去中心化性质，
我们就可以使用区块链+智能合约来实现这个通知的机制。

从流程上，我们可以看出，客户端需要等待的通知有以下几个：

* 创建任务的通知
* 开启训练的通知
* 结束任务的通知

服务器在创建任务、开启训练、结束任务的同时，需要调用智能合约的方法，发布事件，同时客户端监听区块链上相应的事件，
以此来实现通知的功能。

因此，智能合约至少需要实现以下功能：

1. 创建任务：服务器创建任务时调用；参数：任务名称，任务配置的hash，任务执行计划的hash；返回：任务ID，同时发布创建任务事件
2. 开启训练：服务器开启一轮训练时调用；参数：任务ID，任务当前权重的hash；返回：轮次ID，同时发布开启训练事件
3. 结束任务：服务器结束任务时调用；参数：任务ID，任务结果的hash；发布任务结束事件



